<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Mango短剧</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .header {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            cursor: pointer;
            object-fit: contain;
        }
        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 15px;
        }
        .search-input {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }
        .header-icons {
            display: flex;
            gap: 15px;
        }
        .header-icon {
            font-size: 20px;
            cursor: pointer;
            color: #666;
            position: relative;
        }
        .header-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            font-size: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .carousel {
            width: 100%;
            height: 200px;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .carousel img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .section {
            margin: 30px 0;
        }
        .section-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
        }
        .movies-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        .movie-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .movie-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }
        .movie-cover {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
            position: relative;
        }
        .movie-info {
            padding: 10px;
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .movie-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .movie-meta {
            color: #777;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .movie-intro {
            color: #999;
            font-size: 0.8rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;
        }
        /* 改进的收藏按钮样式 */
        .favorite-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            border: none;
            outline: none;
        }
        .favorite-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: scale(1.1);
        }
        .favorite-btn i {
            font-size: 16px;
            color: white;
            transition: color 0.3s ease;
        }
        .favorite-btn.favorited i {
            color: #ff6b6b;
        }
        .favorite-btn.favorited {
            background: rgba(255, 107, 107, 0.9);
        }
        .favorite-btn.favorited:hover {
            background: rgba(255, 107, 107, 1);
        }
        /* 收藏按钮动画 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .favorite-btn.favorited i {
            animation: pulse 0.5s ease;
        }
        /* 新增：卡片底部收藏按钮 */
        .movie-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-top: 1px solid #f0f0f0;
            background: #f9f9f9;
        }
        .card-favorite-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 15px;
            background: #f0f0f0;
            border: none;
            font-size: 12px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .card-favorite-btn:hover {
            background: #e0e0e0;
        }
        .card-favorite-btn.favorited {
            background: #ffebee;
            color: #ff6b6b;
        }
        .card-favorite-btn i {
            font-size: 14px;
        }
        .watch-btn {
            padding: 4px 12px;
            border-radius: 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .watch-btn:hover {
            background: #ff5252;
        }
        /* 搜索结果页面 */
        .search-results-page {
            display: none;
        }
        .search-results-header {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .search-results-header h2 {
            margin-right: 15px;
            font-size: 1.1rem;
        }
        .search-results-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        /* 搜索结果标签页 */
        .search-source-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .search-source-tab {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
        }
        .search-source-tab.active {
            color: #ff6b6b;
            border-bottom-color: #ff6b6b;
        }
        .source-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .source-section.active {
            display: block;
        }
        .source-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .source-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }
        .source-count {
            font-size: 0.8rem;
            color: #777;
        }
        .source-movies-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        /* 播放页面 */
        .video-page {
            display: none;
        }
        .video-player-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px;
            background: black;
            border-radius: 8px;
            overflow: hidden;
        }
        .video-player {
            width: 100%;
            height: 450px;
            background: #000;
        }
        .video-info {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .video-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .video-meta {
            color: #777;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        .episodes-list {
            margin: 20px 0;
        }
        .episodes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .episodes-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        .episodes-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 10px 0;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f5f5f5;
        }
        .episode-item {
            min-width: 80px;
            padding: 10px 15px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .episode-item:hover {
            background: #eee;
        }
        .episode-item.active {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #777;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
        }
        
        /* 新增：收藏记录中的缩略图样式 */
        .favorite-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .favorite-item:hover {
            background-color: #f9f9f9;
        }
        .favorite-item-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .favorite-item-info {
            flex: 1;
            min-width: 0;
        }
        .favorite-item-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .favorite-item-meta {
            font-size: 12px;
            color: #777;
        }
        .favorite-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .remove-favorite-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .movies-grid,
            .source-movies-grid {
                grid-template-columns: 1fr;
            }
            .video-player {
                height: 300px;
            }
            .favorite-item {
                padding: 8px;
            }
            .favorite-item-thumb {
                width: 50px;
                height: 50px;
            }
        }
    </style>
    <!-- 引入字体图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 头部 -->
    <div class="header">
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="搜索短剧名称……">
        </div>
        <div class="header-icons">
            <div class="header-icon" id="historyIcon">
                <i class="fas fa-history"></i>
                <span class="header-badge" id="historyCount">0</span>
            </div>
            <div class="header-icon" id="downloadIcon">
                <i class="fas fa-star"></i>
                <span class="header-badge" id="favoritesCount">0</span>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="container" id="mainContent">
        <!-- 推荐内容 -->
        <div class="section">
            <div class="section-title">推荐</div>
            <div class="movies-grid" id="recommendedMovies">
                <div class="loading">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 搜索结果页面 -->
    <div class="container search-results-page" id="searchResultsPage">
        <div class="search-results-header">
            <h2>搜索结果</h2>
            <div class="search-results-count" id="searchCount">共 0 条结果</div>
        </div>
        <!-- 搜索结果标签页 -->
        <div class="search-source-tabs">
            <div class="search-source-tab active" data-source="hongguo">红果</div>
            <div class="search-source-tab" data-source="hema">河马</div>
        </div>
        <div class="search-results-content" id="searchResultsContent">
            <!-- 红果 -->
            <div class="source-section active" id="sourceSectionHongguo">
                <div class="source-header">
                    <div class="source-name">红果</div>
                    <div class="source-count" id="hongguoCount">共 0 部</div>
                </div>
                <div class="source-movies-grid" id="hongguoGrid">
                    <div class="loading">加载中...</div>
                </div>
            </div>
            <!-- 河马 -->
            <div class="source-section" id="sourceSectionHema">
                <div class="source-header">
                    <div class="source-name">河马</div>
                    <div class="source-count" id="hemaCount">共 0 部</div>
                </div>
                <div class="source-movies-grid" id="hemaGrid">
                    <div class="loading">加载中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 视频播放页面 -->
    <div class="container video-page" id="videoPage">
        <div class="video-player-container">
            <video class="video-player" id="videoPlayer" controls preload="metadata">
                您的浏览器不支持视频播放
            </video>
        </div>
        <div class="video-info">
            <h1 class="video-title" id="videoTitle">视频标题</h1>
            <div class="video-meta" id="videoMeta">点击量 0 | 2025 爱情,动画,奇幻,冒险</div>
        </div>
        <div class="episodes-list">
            <div class="episodes-header">
                <div class="episodes-title">选集</div>
                <div class="episodes-more" id="episodeCount">更新至1集 ></div>
            </div>
            <div class="episodes-scroll" id="episodesScroll">
                <!-- 剧集列表会动态插入到这里 -->
            </div>
        </div>
    </div>

    <!-- 关于我弹窗 -->
    <div class="modal" id="aboutModal">
        <div class="modal-content">
            <span class="modal-close" id="closeAboutModal">&times;</span>
            <h2>关于我</h2>
            <p>感谢使用Mango短剧应用！</p>
            <p>提供海量优质短剧资源，支持番茄/西瓜/红果/蛋花/常读/悟空/河马/繁花/点众 这些平台</p>
            <p>持续更新最新短剧无广告内容！为你带来最佳观看体验！</p>
            <p>本网站源码使用ZC短剧猎手https://www.yrain.top/zcdj.html更新，如有侵权请联系原作者</p>
        </div>
    </div>

    <!-- 收藏弹窗 -->
    <div class="modal" id="favoritesModal">
        <div class="modal-content">
            <span class="modal-close" id="closeFavoritesModal">&times;</span>
            <h2>收藏列表</h2>
            <div id="favoritesContent">暂无收藏内容</div>
        </div>
    </div>

    <!-- 历史观看弹窗 -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <span class="modal-close" id="closeHistoryModal">&times;</span>
            <h2>历史观看</h2>
            <div id="historyContent">暂无历史记录</div>
        </div>
    </div>

    <script>
        class ShortFilmSearch {
            constructor() {
                this.currentPage = 1;
                this.currentKeyword = '';
                this.currentBookId = '';
                this.currentVideoId = '';
                this.searchResults = { hongguo: [], hema: [] };
                this.favorites = JSON.parse(localStorage.getItem('favorites')) || [];
                this.history = JSON.parse(localStorage.getItem('history')) || [];
                this.currentEpisodeIndex = 0;
                this.episodes = [];
                this.currentQuality = '1080P';
                this.autoPlay = true;
                
                this.loadingHongguo = false;
                this.loadingHema = false;
                this.hasMoreHongguo = true;
                this.hasMoreHema = true;
                
                this.currentSource = 'hongguo';
                
                this.initializeElements();
                this.bindEvents();
                this.loadRecommendedContent();
                this.updateHeaderBadges();
            }
            
            initializeElements() {
                this.searchInput = document.getElementById('searchInput');
                this.historyIcon = document.getElementById('historyIcon');
                this.downloadIcon = document.getElementById('downloadIcon');
                this.historyCount = document.getElementById('historyCount');
                this.favoritesCount = document.getElementById('favoritesCount');
                this.recommendedMovies = document.getElementById('recommendedMovies');
                
                this.mainContent = document.getElementById('mainContent');
                this.searchResultsPage = document.getElementById('searchResultsPage');
                this.videoPage = document.getElementById('videoPage');
                
                this.searchResultsContent = document.getElementById('searchResultsContent');
                this.searchCount = document.getElementById('searchCount');
                
                this.searchSourceTabs = document.querySelectorAll('.search-source-tab');
                this.sourceSectionHongguo = document.getElementById('sourceSectionHongguo');
                this.sourceSectionHema = document.getElementById('sourceSectionHema');
                this.hongguoGrid = document.getElementById('hongguoGrid');
                this.hemaGrid = document.getElementById('hemaGrid');
                this.hongguoCount = document.getElementById('hongguoCount');
                this.hemaCount = document.getElementById('hemaCount');
                
                this.videoPlayer = document.getElementById('videoPlayer');
                this.videoTitle = document.getElementById('videoTitle');
                this.videoMeta = document.getElementById('videoMeta');
                this.episodesScroll = document.getElementById('episodesScroll');
                this.episodeCount = document.getElementById('episodeCount');
                
                this.aboutModal = document.getElementById('aboutModal');
                this.closeAboutModal = document.getElementById('closeAboutModal');
                
                this.favoritesModal = document.getElementById('favoritesModal');
                this.historyModal = document.getElementById('historyModal');
                this.closeFavoritesModal = document.getElementById('closeFavoritesModal');
                this.closeHistoryModal = document.getElementById('closeHistoryModal');
            }
            
            bindEvents() {
                if (this.searchInput) this.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleSearch();
                });
                
                if (this.historyIcon) this.historyIcon.addEventListener('click', () => this.openModal('history'));
                if (this.downloadIcon) this.downloadIcon.addEventListener('click', () => this.openModal('favorites'));
                
                // 搜索结果标签页切换事件
                this.searchSourceTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.searchSourceTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        const source = tab.dataset.source;
                        this.currentSource = source;
                        this.showSourceTab(source);
                    });
                });
                
                // 关于我弹窗关闭事件
                if (this.closeAboutModal) this.closeAboutModal.addEventListener('click', () => this.closeModal('about'));
                
                // 滚动加载事件
                window.addEventListener('scroll', this.handleScroll.bind(this));
                
                // 视频播放错误处理
                if (this.videoPlayer) this.videoPlayer.addEventListener('error', (e) => {
                    console.error('视频播放错误:', e);
                    alert('视频加载失败，请尝试刷新页面或换源');
                });
                
                // 视频播放完成事件 - 用于自动连播
                if (this.videoPlayer) this.videoPlayer.addEventListener('ended', () => {
                    if (this.autoPlay && this.episodes.length > 0) {
                        this.playNextEpisode();
                    }
                });
                
                // 弹窗关闭事件
                if (this.closeFavoritesModal) this.closeFavoritesModal.addEventListener('click', () => this.closeModal('favorites'));
                if (this.closeHistoryModal) this.closeHistoryModal.addEventListener('click', () => this.closeModal('history'));
            }
            
            openModal(type) {
                switch(type) {
                    case 'about':
                        if (this.aboutModal) this.aboutModal.style.display = 'flex';
                        break;
                    case 'favorites':
                        this.displayFavorites();
                        if (this.favoritesModal) this.favoritesModal.style.display = 'flex';
                        break;
                    case 'history':
                        this.displayHistory();
                        if (this.historyModal) this.historyModal.style.display = 'flex';
                        break;
                }
            }
            
            closeModal(type) {
                switch(type) {
                    case 'about':
                        if (this.aboutModal) this.aboutModal.style.display = 'none';
                        break;
                    case 'favorites':
                        if (this.favoritesModal) this.favoritesModal.style.display = 'none';
                        break;
                    case 'history':
                        if (this.historyModal) this.historyModal.style.display = 'none';
                        break;
                }
            }
            
            // 更新头部徽章
            updateHeaderBadges() {
                if (this.historyCount) {
                    this.historyCount.textContent = this.history.length > 9 ? '9+' : this.history.length;
                    this.historyCount.style.display = this.history.length > 0 ? 'flex' : 'none';
                }
                
                if (this.favoritesCount) {
                    this.favoritesCount.textContent = this.favorites.length > 9 ? '9+' : this.favorites.length;
                    this.favoritesCount.style.display = this.favorites.length > 0 ? 'flex' : 'none';
                }
            }
            
            // 滚动加载处理函数
            handleScroll() {
                if (this.searchResultsPage.style.display !== 'block') return;
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const windowHeight = window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                if (scrollTop + windowHeight >= documentHeight - 100) {
                    const activeSource = this.currentSource;
                    if (activeSource === 'hongguo' && this.hasMoreHongguo && !this.loadingHongguo) {
                        this.loadMoreResults('hongguo');
                    } else if (activeSource === 'hema' && this.hasMoreHema && !this.loadingHema) {
                        this.loadMoreResults('hema');
                    }
                }
            }
            
            showSourceTab(source) {
                if (source === 'hongguo') {
                    this.sourceSectionHongguo.classList.add('active');
                    this.sourceSectionHema.classList.remove('active');
                } else if (source === 'hema') {
                    this.sourceSectionHema.classList.add('active');
                    this.sourceSectionHongguo.classList.remove('active');
                }
                this.currentSource = source;
            }
            
            async handleSearch() {
                const keyword = this.searchInput?.value.trim();
                if (!keyword) return;
                
                this.currentKeyword = keyword;
                this.searchResults = { hongguo: [], hema: [] };
                this.currentPage = 1;
                this.hasMoreHongguo = true;
                this.hasMoreHema = true;
                this.loadingHongguo = false;
                this.loadingHema = false;
                
                // 显示加载中
                this.hongguoGrid.innerHTML = '<div class="loading">加载中...</div>';
                this.hemaGrid.innerHTML = '<div class="loading">加载中...</div>';
                
                // 同时请求两个接口的第一页
                await Promise.all([
                    this.loadSearchResults('hongguo', 1),
                    this.loadSearchResults('hema', 1)
                ]);
                
                // 切换到搜索结果页面
                if (this.mainContent) this.mainContent.style.display = 'none';
                if (this.searchResultsPage) this.searchResultsPage.style.display = 'block';
                if (this.videoPage) this.videoPage.style.display = 'none';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            async loadSearchResults(source, page) {
                if (source === 'hongguo') {
                    this.loadingHongguo = true;
                } else if (source === 'hema') {
                    this.loadingHema = true;
                }
                
                try {
                    let apiUrl;
                    if (source === 'hongguo') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/api.php?name=${encodeURIComponent(this.currentKeyword)}&page=${page}`;
                    } else if (source === 'hema') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/hema.php?name=${encodeURIComponent(this.currentKeyword)}&page=${page}`;
                    }
                    
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        const newResults = data.data.filter(newItem => 
                            !this.searchResults[source].some(existingItem => existingItem.book_id === newItem.book_id)
                        );
                        this.searchResults[source] = [...this.searchResults[source], ...newResults];
                        
                        if (newResults.length === 0) {
                            if (source === 'hongguo') this.hasMoreHongguo = false;
                            if (source === 'hema') this.hasMoreHema = false;
                        }
                        this.displaySearchResults(source);
                    } else {
                        if (source === 'hongguo') this.hasMoreHongguo = false;
                        if (source === 'hema') this.hasMoreHema = false;
                    }
                } catch (error) {
                    console.error(`加载${source}结果失败:`, error);
                    if (source === 'hongguo') this.hasMoreHongguo = false;
                    if (source === 'hema') this.hasMoreHema = false;
                } finally {
                    if (source === 'hongguo') {
                        this.loadingHongguo = false;
                    } else if (source === 'hema') {
                        this.loadingHema = false;
                    }
                }
            }
            
            displaySearchResults(source) {
                const grid = source === 'hongguo' ? this.hongguoGrid : this.hemaGrid;
                const countElement = source === 'hongguo' ? this.hongguoCount : this.hemaCount;
                
                if (this.searchResults[source].length > 0 && grid.innerHTML.includes('加载中')) {
                    grid.innerHTML = '';
                }
                
                const startIndex = grid.children.length;
                for (let i = startIndex; i < this.searchResults[source].length; i++) {
                    const movie = this.searchResults[source][i];
                    const card = this.createMovieCard(movie, true);
                    grid.appendChild(card);
                }
                
                if (countElement) countElement.textContent = `共 ${this.searchResults[source].length} 部`;
                
                const total = this.searchResults.hongguo.length + this.searchResults.hema.length;
                if (this.searchCount) this.searchCount.textContent = `共 ${total} 条结果`;
            }
            
            async loadMoreResults(source) {
                if (source === 'hongguo' && !this.hasMoreHongguo) return;
                if (source === 'hema' && !this.hasMoreHema) return;
                
                const nextPage = Math.floor(this.searchResults[source].length / 10) + 1;
                await this.loadSearchResults(source, nextPage);
            }
            
            createMovieCard(movie, isSearchResult = false) {
                const card = document.createElement('div');
                card.className = 'movie-card';
                
                let introText = movie.intro || movie.title;
                if (typeof introText !== 'string') {
                    introText = movie.title || '暂无简介';
                }
                
                const isFavorited = this.isFavorite(movie);
                
                card.innerHTML = `
                    <div class="movie-cover">
                        <img src="${movie.cover}" alt="${movie.title}" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNSIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veS4lueVjCk8L3RleHQ+PC9zdmc+'">
                        <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" data-book-id="${movie.book_id}">
                            <i class="fas fa-star"></i>
                        </button>
                    </div>
                    <div class="movie-info">
                        <div class="movie-title">${this.escapeHtml(movie.title)}</div>
                        <div class="movie-meta">${movie.author || '未知主演'}</div>
                        <div class="movie-intro">${this.escapeHtml(introText)}</div>
                    </div>
                    <div class="movie-actions">
                        <button class="card-favorite-btn ${isFavorited ? 'favorited' : ''}" data-book-id="${movie.book_id}">
                            <i class="fas fa-star"></i>
                            <span>${isFavorited ? '已收藏' : '收藏'}</span>
                        </button>
                        <button class="watch-btn" data-book-id="${movie.book_id}">
                            立即观看
                        </button>
                    </div>
                `;
                
                // 添加封面收藏按钮事件
                const coverFavoriteBtn = card.querySelector('.favorite-btn');
                coverFavoriteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.handleFavoriteClick(movie, coverFavoriteBtn);
                });
                
                // 添加底部收藏按钮事件
                const cardFavoriteBtn = card.querySelector('.card-favorite-btn');
                cardFavoriteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.handleFavoriteClick(movie, cardFavoriteBtn, coverFavoriteBtn);
                });
                
                // 添加观看按钮事件
                const watchBtn = card.querySelector('.watch-btn');
                watchBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectMovie(movie);
                });
                
                card.addEventListener('click', () => {
                    this.selectMovie(movie);
                });
                
                return card;
            }
            
            handleFavoriteClick(movie, button, coverButton = null) {
                const wasFavorited = this.isFavorite(movie);
                this.toggleFavorite(movie);
                const isNowFavorited = this.isFavorite(movie);
                
                // 更新按钮状态
                button.classList.toggle('favorited', isNowFavorited);
                
                // 更新封面按钮状态（如果提供了）
                if (coverButton) {
                    coverButton.classList.toggle('favorited', isNowFavorited);
                }
                
                // 更新底部按钮文本
                if (button.classList.contains('card-favorite-btn')) {
                    const span = button.querySelector('span');
                    if (span) {
                        span.textContent = isNowFavorited ? '已收藏' : '收藏';
                    }
                }
                
                // 更新头部徽章
                this.updateHeaderBadges();
                
                // 显示反馈
                this.showFavoriteFeedback(wasFavorited, isNowFavorited);
            }
            
            showFavoriteFeedback(wasFavorited, isNowFavorited) {
                // 可以在这里添加Toast通知
                if (!wasFavorited && isNowFavorited) {
                    console.log('已添加到收藏');
                } else if (wasFavorited && !isNowFavorited) {
                    console.log('已从收藏中移除');
                }
            }
            
            toggleFavorite(movie) {
                const index = this.favorites.findIndex(f => f.book_id === movie.book_id);
                if (index > -1) {
                    this.favorites.splice(index, 1);
                } else {
                    this.favorites.push(movie);
                }
                localStorage.setItem('favorites', JSON.stringify(this.favorites));
            }
            
            isFavorite(movie) {
                return this.favorites.some(f => f.book_id === movie.book_id);
            }
            
            async selectMovie(movie) {
                console.log('正在选择电影:', movie);
                this.currentBookId = movie.book_id;
                this.addHistory(movie);
                this.displayMovieDetail(movie);
                await this.loadEpisodes(movie.book_id);
                this.showVideoPage();
            }
            
            displayMovieDetail(movie) {
                if (this.videoTitle) this.videoTitle.textContent = movie.title;
                if (this.videoMeta) {
                    const playCnt = Number(movie.play_cnt) || 0;
                    const typeText = Array.isArray(movie.type) ? movie.type.join(', ') : (movie.type || '爱情,动画,奇幻,冒险');
                    this.videoMeta.textContent = `点击量 ${this.formatNumber(playCnt)} | ${movie.year || '2025'} ${typeText}`;
                }
                
                if (this.episodeCount) {
                    const episodeCnt = movie.episode_cnt || 1;
                    this.episodeCount.textContent = `更新至${episodeCnt}集 >`;
                }
            }
            
            async loadEpisodes(bookId) {
                try {
                    let response;
                    if (this.currentSource === 'hongguo') {
                        response = await fetch(`https://api.cenguigui.cn/api/duanju/api.php?book_id=${bookId}`);
                    } else if (this.currentSource === 'hema') {
                        response = await fetch(`https://api.cenguigui.cn/api/duanju/hema.php?book_id=${bookId}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.code === 200 && Array.isArray(data.data)) {
                        if (this.currentSource === 'hema') {
                            this.episodes = data.data.map(episode => ({
                                ...episode,
                                book_id: data.book_id,
                                book_name: data.book_name
                            }));
                        } else {
                            this.episodes = data.data;
                        }
                        this.displayEpisodes(this.episodes);
                    } else {
                        alert('获取剧集失败: ' + (data.msg || '未知错误'));
                    }
                } catch (error) {
                    alert('获取剧集失败: ' + error.message);
                }
            }
            
            displayEpisodes(episodes) {
                if (!this.episodesScroll) return;
                this.episodesScroll.innerHTML = '';
                episodes.forEach((episode, index) => {
                    const btn = document.createElement('div');
                    btn.className = 'episode-item';
                    btn.textContent = episode.title;
                    btn.addEventListener('click', () => this.playEpisode(episode.video_id, episode.title, index));
                    this.episodesScroll.appendChild(btn);
                });
                
                if (episodes.length > 0) {
                    this.playEpisode(episodes[0].video_id, episodes[0].title, 0);
                }
            }
            
            async playEpisode(videoId, title, index) {
                try {
                    this.currentEpisodeIndex = index;
                    
                    let apiUrl;
                    if (this.currentSource === 'hongguo') {
                        apiUrl = `https://api.cenguigui.cn/api/duanju/api.php?video_id=${videoId}`;
                    } else if (this.currentSource === 'hema') {
                        const bookId = this.episodes[index]?.book_id;
                        const bookName = this.episodes[index]?.book_name;
                        if (bookId && bookName) {
                            apiUrl = `https://api.cenguigui.cn/api/duanju/hema.php?book_id=${bookId}&book_name=${encodeURIComponent(bookName)}&video_id=${videoId}`;
                        } else {
                            alert('播放失败: 缺少必要参数');
                            return;
                        }
                    }
                    
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        const videoUrl = data.data.url;
                        if (this.videoPlayer) {
                            this.videoPlayer.src = videoUrl;
                            this.videoPlayer.load();
                        }
                        
                        const buttons = this.episodesScroll.querySelectorAll('.episode-item');
                        buttons.forEach((btn, i) => {
                            if (i === index) {
                                btn.classList.add('active');
                            } else {
                                btn.classList.remove('active');
                            }
                        });
                    } else {
                        alert('播放失败: ' + (data.msg || '未知错误'));
                    }
                } catch (error) {
                    alert('播放失败: ' + error.message);
                }
            }
            
            playNextEpisode() {
                if (this.episodes.length === 0) return;
                
                const nextIndex = (this.currentEpisodeIndex + 1) % this.episodes.length;
                const nextEpisode = this.episodes[nextIndex];
                this.playEpisode(nextEpisode.video_id, nextEpisode.title, nextIndex);
            }
            
            showVideoPage() {
                if (this.mainContent) this.mainContent.style.display = 'none';
                if (this.searchResultsPage) this.searchResultsPage.style.display = 'none';
                if (this.videoPage) this.videoPage.style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            async loadRecommendedContent() {
                try {
                    const keywords = ['热门', '总裁', '校园', '系统', '无敌','神豪'];
                    const randomKeyword = keywords[Math.floor(Math.random() * keywords.length)];
                    const randomPage = Math.floor(Math.random() * 7) + 1;
                    
                    const response = await fetch(`https://api.cenguigui.cn/api/duanju/api.php?name=${encodeURIComponent(randomKeyword)}&page=${randomPage}`);
                    const data = await response.json();
                    
                    if (data.code === 200) {
                        const movies = data.data.slice(0, 10);
                        this.displayMoviesGrid(movies, this.recommendedMovies);
                    } else {
                        if (this.recommendedMovies) this.recommendedMovies.innerHTML = '<div class="error">推荐内容加载失败</div>';
                    }
                } catch (error) {
                    if (this.recommendedMovies) this.recommendedMovies.innerHTML = '<div class="error">推荐内容加载失败</div>';
                }
            }
            
            displayMoviesGrid(movies, container) {
                if (!container) return;
                container.innerHTML = '';
                if (movies.length === 0) {
                    container.innerHTML = '<div class="error">暂无内容</div>';
                    return;
                }
                
                movies.forEach(movie => {
                    const card = this.createMovieCard(movie);
                    container.appendChild(card);
                });
            }
            
            addHistory(movie) {
                const existingIndex = this.history.findIndex(item => item.book_id === movie.book_id);
                if (existingIndex > -1) {
                    this.history.splice(existingIndex, 1);
                }
                this.history.unshift(movie);
                if (this.history.length > 10) {
                    this.history = this.history.slice(0, 10);
                }
                localStorage.setItem('history', JSON.stringify(this.history));
                this.updateHeaderBadges();
            }
            
            displayFavorites() {
                const favoritesContent = document.getElementById('favoritesContent');
                if (!favoritesContent) return;
                if (this.favorites.length === 0) {
                    favoritesContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暂无收藏内容</div>';
                    return;
                }
                
                favoritesContent.innerHTML = '';
                this.favorites.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'favorite-item';
                    
                    div.innerHTML = `
                        <img src="${item.cover}" 
                             class="favorite-item-thumb"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNSIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veS4lueVjCk8L3RleHQ+PC9zdmc+'">
                        <div class="favorite-item-info">
                            <div class="favorite-item-title">${this.escapeHtml(item.title)}</div>
                            <div class="favorite-item-meta">${item.author || '未知主演'} | ${item.year || '2025'}</div>
                        </div>
                        <div class="favorite-item-actions">
                            <button class="remove-favorite-btn" data-book-id="${item.book_id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    div.addEventListener('click', (e) => {
                        if (!e.target.closest('.remove-favorite-btn')) {
                            this.selectMovie(item);
                            this.closeModal('favorites');
                        }
                    });
                    
                    const removeBtn = div.querySelector('.remove-favorite-btn');
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.removeFavorite(item.book_id);
                        div.remove();
                        if (this.favorites.length === 0) {
                            favoritesContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暂无收藏内容</div>';
                        }
                    });
                    
                    favoritesContent.appendChild(div);
                });
            }
            
            removeFavorite(bookId) {
                const index = this.favorites.findIndex(f => f.book_id === bookId);
                if (index > -1) {
                    this.favorites.splice(index, 1);
                    localStorage.setItem('favorites', JSON.stringify(this.favorites));
                    this.updateHeaderBadges();
                }
            }
            
            displayHistory() {
                const historyContent = document.getElementById('historyContent');
                if (!historyContent) return;
                if (this.history.length === 0) {
                    historyContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">暂无历史记录</div>';
                    return;
                }
                
                historyContent.innerHTML = '';
                this.history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'favorite-item';
                    
                    div.innerHTML = `
                        <img src="${item.cover}" 
                             class="favorite-item-thumb"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNSIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+WKoOi9veS4lueVjCk8L3RleHQ+PC9zdmc+'">
                        <div class="favorite-item-info">
                            <div class="favorite-item-title">${this.escapeHtml(item.title)}</div>
                            <div class="favorite-item-meta">${item.author || '未知主演'} | ${item.year || '2025'}</div>
                        </div>
                    `;
                    
                    div.addEventListener('click', () => {
                        this.selectMovie(item);
                        this.closeModal('history');
                    });
                    
                    historyContent.appendChild(div);
                });
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            formatNumber(num) {
                if (typeof num !== 'number' || isNaN(num)) {
                    return '0';
                }
                if (num >= 10000) {
                    return (num / 10000).toFixed(1) + '万';
                }
                return num.toLocaleString();
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new ShortFilmSearch();
        });
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"73ddbb2c8a904279a298d10e3d0b3e4a","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
